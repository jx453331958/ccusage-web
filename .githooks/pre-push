#!/bin/bash
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

IMAGE="ghcr.io/jx453331958/ccusage-web"

print_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
print_error() { echo -e "${RED}[ERROR]${NC} $1"; }

get_version_tag() {
    TAG=$(git tag --points-at HEAD 2>/dev/null | grep '^v' | head -1)
    if [ -n "$TAG" ]; then
        echo "$TAG"
    else
        git rev-parse --short HEAD
    fi
}

ensure_buildx() {
    if ! docker buildx inspect ccusage-builder &>/dev/null; then
        print_info "Creating buildx builder..."
        docker buildx create --name ccusage-builder --use
    else
        docker buildx use ccusage-builder
    fi
}

check_login() {
    if ! docker login ghcr.io --get-login &>/dev/null 2>&1; then
        print_error "Not logged in to ghcr.io. Run: docker login ghcr.io -u <username>"
        exit 1
    fi
}

VERSION_TAG=$(get_version_tag)

echo ""
print_info "=== Pre-push: Build & Push Docker Image ==="
print_info "Tags: latest, ${VERSION_TAG}"
echo ""

check_login
ensure_buildx

print_info "Building and pushing Docker image (amd64 + arm64)..."
docker buildx build \
    --platform linux/amd64,linux/arm64 \
    -t "${IMAGE}:latest" \
    -t "${IMAGE}:${VERSION_TAG}" \
    --push \
    .

print_info "Docker image pushed. Continuing git push..."
